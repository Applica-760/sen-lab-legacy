# ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ€ãƒ¼æŠ½è±¡åŒ–ã¨NPYå½¢å¼ã‚µãƒãƒ¼ãƒˆã®å®Ÿè£…

## ğŸ“‹ å®Ÿè£…æ¦‚è¦

ã“ã®ãƒ–ãƒ©ãƒ³ãƒã§ã¯ã€ESNãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æ©Ÿæ§‹ã‚’æŠ½è±¡åŒ–ã—ã€å‰å‡¦ç†æ¸ˆã¿NPYå½¢å¼ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã“ã¨ã§ã€å­¦ç¿’ãƒ»æ¨è«–ã®é«˜é€ŸåŒ–ã‚’å®Ÿç¾ã—ã¾ã—ãŸã€‚

## âœ¨ ä¸»ãªå¤‰æ›´ç‚¹

### Phase 1: ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ€ãƒ¼ã®æŠ½è±¡åŒ–
- âœ… `BaseDataLoader` æŠ½è±¡åŸºåº•ã‚¯ãƒ©ã‚¹ã®è¿½åŠ 
- âœ… `CSVDataLoader` ã«ã‚ˆã‚‹æ—¢å­˜CSV+ç”»åƒå½¢å¼ã®ã‚«ãƒ—ã‚»ãƒ«åŒ–
- âœ… ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®è¨­è¨ˆï¼ˆãƒ¡ãƒ¢ãƒªåŠ¹ç‡åŒ–ï¼‰
- âœ… Ragged arrayå¯¾å¿œï¼ˆå¯å¤‰é•·æ™‚ç³»åˆ—ï¼‰
- âœ… å®Œå…¨ãªå¾Œæ–¹äº’æ›æ€§

### Phase 2: å‰å‡¦ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè£…
- âœ… `tools/dataprep/convert_10fold_to_npy.py` ã®ä½œæˆ
- âœ… CSV+ç”»åƒ â†’ NPZå½¢å¼ã¸ã®å¤‰æ›
- âœ… Ragged arrayå½¢å¼ã§ã®ä¿å­˜ï¼ˆå¯å¤‰é•·æ™‚ç³»åˆ—å¯¾å¿œï¼‰
- âœ… ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†ï¼ˆJSONå½¢å¼ï¼‰
- âœ… é€²æ—è¡¨ç¤ºã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€dry-runãƒ¢ãƒ¼ãƒ‰

### Phase 3: NPYDataLoaderã®å®Ÿè£…
- âœ… `NPYDataLoader` ã«ã‚ˆã‚‹å‰å‡¦ç†æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã®é«˜é€Ÿèª­ã¿è¾¼ã¿
- âœ… mmapæ©Ÿèƒ½ã«ã‚ˆã‚‹é…å»¶èª­ã¿è¾¼ã¿
- âœ… BaseDataLoaderã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®å®Œå…¨å®Ÿè£…

### Phase 4: è¨­å®šåˆ‡ã‚Šæ›¿ãˆã®å®Ÿè£…
- âœ… `DataSourceCfg` è¨­å®šã‚¯ãƒ©ã‚¹ã®è¿½åŠ 
- âœ… `create_data_loader_from_config` Factoryãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…
- âœ… è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹åˆ‡ã‚Šæ›¿ãˆ
- âœ… æ—§è¨­å®šã¨ã®å¾Œæ–¹äº’æ›æ€§

## ğŸ“ æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«

```
src/esn_lab/pipeline/data/
â”œâ”€â”€ __init__.py              # ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
â”œâ”€â”€ base.py                  # BaseDataLoader æŠ½è±¡åŸºåº•ã‚¯ãƒ©ã‚¹
â”œâ”€â”€ csv_loader.py            # CSVDataLoaderï¼ˆæ—¢å­˜å½¢å¼ï¼‰
â”œâ”€â”€ npy_loader.py            # NPYDataLoaderï¼ˆæ–°å½¢å¼ï¼‰
â””â”€â”€ factory.py               # DataLoader Factory

tools/dataprep/
â””â”€â”€ convert_10fold_to_npy.py # å‰å‡¦ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

configs/train/
â””â”€â”€ tenfold_npy.yaml         # NPYå½¢å¼ç”¨è¨­å®šä¾‹
```

## ğŸš€ ä½¿ã„æ–¹

### 1. ãƒ‡ãƒ¼ã‚¿ã®å‰å‡¦ç†ï¼ˆåˆå›ã®ã¿ï¼‰

```bash
# CSV + ç”»åƒ â†’ NPYå½¢å¼ã«å¤‰æ›
python tools/dataprep/convert_10fold_to_npy.py \
    --csv-dir dataset/10fold_csvs/ \
    --output-dir dataset/10fold_npy/ \
    --format npz

# dry-runã§äº‹å‰ç¢ºèª
python tools/dataprep/convert_10fold_to_npy.py \
    --csv-dir dataset/10fold_csvs/ \
    --output-dir dataset/10fold_npy/ \
    --dry-run
```

### 2. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç·¨é›†

#### NPYå½¢å¼ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆï¼ˆæ¨å¥¨ï¼‰

```yaml
# configs/train/tenfold.yaml
data_source:
  type: "npy"
  npy_dir: "dataset/10fold_npy/"

experiment_name: "tenfold_npy_test"
workers: 10
```

#### CSVå½¢å¼ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆï¼ˆæ—¢å­˜ï¼‰

```yaml
# æ—§å½¢å¼ï¼ˆå¾Œæ–¹äº’æ›ï¼‰
csv_dir: "dataset/10fold_csvs/"

# ã¾ãŸã¯æ–°å½¢å¼ã§æ˜ç¤ºçš„ã«æŒ‡å®š
data_source:
  type: "csv"
  csv_dir: "dataset/10fold_csvs/"
```

### 3. è¨“ç·´ã®å®Ÿè¡Œ

```bash
# é€šå¸¸é€šã‚Šå®Ÿè¡Œï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ€ãƒ¼ã¯è‡ªå‹•é¸æŠï¼‰
esnlab train tenfold
```

## ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„

### æœŸå¾…ã•ã‚Œã‚‹é«˜é€ŸåŒ–

- **ç¾åœ¨ï¼ˆCSV+ç”»åƒï¼‰**: `cv2.imread()` Ã— æ•°åä¸‡å› = æ•°æ™‚é–“ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰
- **NPYå½¢å¼**: ãƒ¡ãƒ¢ãƒªãƒãƒƒãƒ—èª­ã¿è¾¼ã¿ = **100å€ä»¥ä¸Šã®é«˜é€ŸåŒ–**

### ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡

- **fold_a.npzï¼ˆ255ã‚µãƒ³ãƒ—ãƒ«ï¼‰**: 249 MBï¼ˆåœ§ç¸®æ¸ˆã¿ï¼‰
- **å…¨10 fold**: ç´„2.5 GB

## ğŸ”§ æŠ€è¡“çš„è©³ç´°

### Ragged Arrayå½¢å¼

å„foldã¯`fold_{id}.npz`ã¨ã—ã¦ä¿å­˜ã•ã‚Œã€å†…éƒ¨æ§‹é€ ã¯ä»¥ä¸‹ã®é€šã‚Šï¼š

```python
{
    "num_samples": int,              # ã‚µãƒ³ãƒ—ãƒ«æ•°
    "fold_id": str,                  # fold ID ('a', 'b', ...)
    "sample_0_data": ndarray,        # (T_0, 256) æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿
    "sample_0_id": str,              # ã‚µãƒ³ãƒ—ãƒ«ID
    "sample_0_class": int,           # ã‚¯ãƒ©ã‚¹ID
    "sample_1_data": ndarray,        # (T_1, 256) â€»å¯å¤‰é•·
    "sample_1_id": str,
    "sample_1_class": int,
    ...
}
```

### ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆmetadata.jsonï¼‰

```json
{
  "created_at": "2025-01-01T00:00:00",
  "format": "npz_ragged",
  "folds": {
    "fold_a": {
      "sample_id_1": 0,
      "sample_id_2": 1,
      ...
    }
  },
  "conversion_stats": [...]
}
```

## âœ… å‹•ä½œç¢ºèªæ¸ˆã¿

- âœ… å‰å‡¦ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆdry-run & å®Ÿè¡Œï¼‰
- âœ… NPYDataLoaderã®èª­ã¿è¾¼ã¿å‹•ä½œ
- âœ… CSVDataLoaderï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
- âœ… Factory pattern ã«ã‚ˆã‚‹åˆ‡ã‚Šæ›¿ãˆ
- âœ… å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ãªã—

## ğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **å®Ÿãƒ‡ãƒ¼ã‚¿ã§ã®çµ±åˆãƒ†ã‚¹ãƒˆ**: å®Ÿéš›ã®10-foldå­¦ç¿’ã‚’å®Ÿè¡Œã—ã¦å‹•ä½œç¢ºèª
2. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®š**: CSV vs NPY ã®å®Ÿè¡Œæ™‚é–“ã‚’æ¯”è¼ƒ
3. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°**: readme.md ã«NPYå½¢å¼ã®èª¬æ˜ã‚’è¿½åŠ 
4. **evaluateç³»ã®å¯¾å¿œ**: evaluate tenfold ã§ã‚‚NPYå½¢å¼ã‚’ä½¿ç”¨å¯èƒ½ã«

## ğŸ¯ è¨­è¨ˆä¸Šã®åˆ©ç‚¹

1. **æŠ½è±¡åŒ–**: ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ãŒåˆ†é›¢
2. **æ‹¡å¼µæ€§**: æ–°ã—ã„ãƒ­ãƒ¼ãƒ€ãƒ¼ï¼ˆHDF5, Zarrç­‰ï¼‰ã‚’ç°¡å˜ã«è¿½åŠ å¯èƒ½
3. **å¾Œæ–¹äº’æ›æ€§**: æ—¢å­˜ã®CSVå½¢å¼ã‚‚å¼•ãç¶šãä½¿ç”¨å¯èƒ½
4. **ãƒ¡ãƒ¢ãƒªåŠ¹ç‡**: ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ã«å¯¾å¿œ
5. **ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£**: ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ç°¡å˜ã«æ³¨å…¥å¯èƒ½

## ğŸ› æ—¢çŸ¥ã®åˆ¶é™äº‹é …

- evaluateç³»ã®ä¸€éƒ¨æ©Ÿèƒ½ã¯ã¾ã NPYå½¢å¼ã«å®Œå…¨å¯¾å¿œã—ã¦ã„ãªã„å¯èƒ½æ€§ã‚ã‚Š
- tqdmãŒä¾å­˜é–¢ä¿‚ã«è¿½åŠ ã•ã‚ŒãŸãŸã‚ã€`pip install -e .` ã§ã®å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¿…è¦

## ğŸ“š å‚è€ƒ

- BaseDataLoader: `src/esn_lab/pipeline/data/base.py`
- Factory pattern: `src/esn_lab/pipeline/data/factory.py`
- å‰å‡¦ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ: `tools/dataprep/convert_10fold_to_npy.py`
